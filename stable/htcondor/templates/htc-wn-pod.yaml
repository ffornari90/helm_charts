apiVersion: apps/v1
kind: Deployment
metadata:
  name: wn-pod
  labels:
    app.kubernetes.io/name: wn-pod
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: wn
    spec:
      dnsPolicy: None
      dnsConfig:
        nameservers:
        - 8.8.8.8
      affinity:
{{- if .Values.htcWn.nodeSelector }}
{{ .Values.htcWn.nodeSelector | indent 8 }}
{{- end }}
        {{- if or .Values.cvmfs.enabled .Values.nfs.enabled }}
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                {{- if .Values.cvmfs.enabled }}
                - cvmfs
                {{- end }}
            topologyKey: kubernetes.io/hostname
        {{- end }}
      {{- if .Values.ttsCache.enabled }}
      serviceAccountName: tts-account
      {{- end }}
      containers:
      {{- if .Values.ttsCache.enabled }}
      - name: tts
        imagePullPolicy: Always
        image: dodasts/tts-cache:v0.1.1-k8s
        args:
          - --get-proxy
          - --period
          - "120"
        resources:
          limits:
            memory: "500M"
            cpu: "100m"
        volumeMounts:
          - name: proxydir
            mountPath: /root/proxy
      {{- end }}
      - name: wn
        imagePullPolicy: {{ .Values.htcWn.pullPolicy }}
        args:
        - wn 
        env:
        - name: CONDOR_HOST 
          value: "{{ .Values.condorHost }}"
        - name: PROXY_CACHE 
          value: "{{ .Values.proxyCacheHost }}:{{ .Values.proxyCachePort }}"
        - name: CCB_ADDRESS
          value:  "{{ .Values.ccbHost }}"
        - name: SLOT_TYPE_1
          value: "{{ .Values.htcWn.slotType }}"

        image: "{{ .Values.htcWn.image }}:{{ .Values.htcWn.tag }}"
        livenessProbe:
          exec:
            command:
            #- cat
            #- /cvmfs/spiga.local.repo/test-content
            - voms-proxy-info
            - --file
            - /root/gwms_proxy
            - -e
          initialDelaySeconds: 300
          periodSeconds: 600
        resources:
          limits:
            memory: "{{ .Values.htcWn.ram.limit }}"
            cpu: "{{ .Values.htcWn.cpu.limit }}"
          requests: 
            memory: "{{ .Values.htcWn.ram.request }}"
            cpu: "{{ .Values.htcWn.cpu.request }}"
        volumeMounts:
{{- if .Values.nfs.enabled }}
        - name: nfs
          mountPath: "/mnt"
{{- end }}
{{- if .Values.cvmfs.enabled }}
        - name: cvmfs
          mountPath: "/cvmfs"
          #mountPropagation: Bidirectional
{{- end }}
{{- if .Values.htcWn.siteConfCMS.enabled }}
{{- range  .Values.htcWn.siteConfCMS.files }}
        - name: {{ .name }}
          mountPath: /etc/cvmfs/SITECONF/{{ .path }}
{{- end }}
{{- end }}
{{- if .Values.ttsCache.enabled }}
          - name: proxydir
            mountPath: /root/proxy
{{- end }}
      volumes:
{{- if .Values.ttsCache.enabled }}
      - name: proxydir
        emptyDir: {}
{{- end }}
{{- if .Values.nfs.enabled }}
      - name: nfs
        persistentVolumeClaim:
          claimName: nfs
{{- end }}
{{- if .Values.cvmfs.enabled }}
      - name: cvmfs
        hostPath:
          path: /cvmfs
          type: Directory
{{- end }}
{{- if .Values.htcWn.siteConfCMS.enabled }}
{{- range  .Values.htcWn.siteConfCMS.files }}
      - name: {{ .name }}
        configMap:
          name: {{ .name }}
{{- end }}
{{- end }}

  selector:
    matchLabels:
      app.kubernetes.io/name: wn 

  replicas: {{ .Values.htcWn.replicas }}
